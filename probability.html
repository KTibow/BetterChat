<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classifier Test | Better Chat</title>
    <style>
        body {
            font-family: system-ui;
            background-color: #234;
            color: white;
        }
        ::placeholder {
            color: #ccc;
        }
        input {
            border: none;
            background-color: #345;
            color: white;
            padding: 0.5em;
        }
    </style>
</head>
<body>
    <h1>Test out the Better Chat classifier</h1>
    Is the sender unmigrated (influences if it could be IRL trading)? <input type="checkbox" checked><br>
    <input type="text" id="input" placeholder="Enter a message to classify">
    <h2>Stripped version</h2>
    <p id="stripped"></p>
    <h2>Classification</h2>
    <table></table>
    <script>
        window.exampleMessages = {};
        (async () => {
            window.exampleMessages = await fetch("messages.json").then(r => r.json());
        })();
        const isUnmigrated = document.querySelector("input[type=checkbox]");
        const input = document.querySelector("input[type=text]");
        const stripped = document.getElementById("stripped");
        const table = document.querySelector("table");
        const tokenizeText = (text) => {
            // First, all unicode characters are replaced with the plain version using .normalize("NFKC")
            // Then, all non-alphanumeric characters are replaced with a space (consecutive spaces are removed and trimmed)
            // Then, the text is lowercased
            // Finally, the text is tokenized
            return text.normalize("NFKC").replace(/[^\w\s]/g, " ").toLowerCase().trim().split(/\s+/);
        };
        const getTokenProbabilities = async (countIrlTrading) => {
            // Each message has its key as the message, and the value as:
            // nothing: fine
            // b: trading
            // c: irl trading
            var fineTokens = {};
            var tradingTokens = {};
            var irlTradingTokens = {};
            for (message in exampleMessages) {
                let messageClass = exampleMessages[message];
                const tokens = new Set(tokenizeText(message.split(":").splice(1).join(":")));
                for (token of tokens) {
                    if (messageClass == "") {
                        fineTokens[token] = (fineTokens[token] || 0) + 1;
                    } else if (messageClass == "b") {
                        tradingTokens[token] = (tradingTokens[token] || 0) + 1;
                    } else if (messageClass == "c" && countIrlTrading) {
                        irlTradingTokens[token] = (irlTradingTokens[token] || 0) + 1;
                    }
                }
            }
            // Then calculate each token's bayesian probability
            const tokenProbabilities = {};
            for (token in {...fineTokens, ...tradingTokens, ...irlTradingTokens}) {
                const fineCount = fineTokens[token] || 0;
                const spamCount = tradingTokens[token] || 0 + irlTradingTokens[token] || 0;
                // P(spam | token) = P(token | spam) / (P(token | fine) + P(token | spam))
                const tokenGivenSpam = spamCount / (Object.keys(tradingTokens).length + Object.keys(irlTradingTokens).length);
                const tokenGivenFine = fineCount / Object.keys(fineTokens).length;
                tokenProbabilities[token] = tokenGivenSpam / (tokenGivenSpam + tokenGivenFine);
                tokenProbabilities[token] = Math.min(Math.max(tokenProbabilities[token], 0.01), 0.99);
            }
        };
        const classify = () => {
            const text = input.value;
            const textTokens = tokenizeText(text);
            stripped.textContent = textTokens.join(" ");
            const tokenProbabilities = getTokenProbabilities(isUnmigrated.checked);
            const spamProb = 1;
            const notSpamProb = 1;
            for (token of textTokens) {
                if (tokenProbabilities[token] == undefined) {
                    continue;
                }
                spamProb *= tokenProbabilities[token];
                notSpamProb *= (1 - tokenProbabilities[token]);
            }
            const spamProbability = spamProb / (spamProb + notSpamProb);
            console.log(spamProbability);
        };
        input.addEventListener("keyup", (e) => {
            classify();
        });
    </script>
</body>
</html>
